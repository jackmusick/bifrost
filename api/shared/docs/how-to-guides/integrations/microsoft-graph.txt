# Automate Microsoft 365 User Management

Create, update, and manage Microsoft 365 users with Microsoft Graph API

---

Automate common Microsoft 365 user management tasks using Microsoft Graph API. This guide shows practical patterns for MSP workflows.

## Prerequisites

-   [OAuth connection configured](/getting-started/integrations) for Microsoft Graph
-   Required scopes: `User.ReadWrite.All`, `Group.ReadWrite.All`

## Basic Pattern

All Microsoft Graph workflows follow the same structure:

```python
from bifrost import workflow, integrations
import aiohttp

@workflow
async def graph_workflow() -> dict:
    """Example Graph API workflow."""
    # Get integration with OAuth token
    integration = await integrations.get("Microsoft")
    if not integration or not integration.oauth:
        raise ValueError("Microsoft Graph OAuth not configured")

    # Make API call
    url = "https://graph.microsoft.com/v1.0/users"
    headers = {"Authorization": f"Bearer {integration.oauth.access_token}"}

    async with aiohttp.ClientSession() as session:
        async with session.get(url, headers=headers) as resp:
            resp.raise_for_status()
            return await resp.json()
```

    Bifrost automatically refreshes expired tokens. Always get a fresh token at
    the start of your workflow.

## List Users

Get all users in the tenant:

```python
from bifrost import workflow, integrations
import aiohttp

@workflow
async def list_users() -> dict:
    """Get all users."""
    integration = await integrations.get("Microsoft")
    if not integration or not integration.oauth:
        raise ValueError("Microsoft Graph OAuth not configured")

    url = "https://graph.microsoft.com/v1.0/users"
    headers = {"Authorization": f"Bearer {integration.oauth.access_token}"}

    async with aiohttp.ClientSession() as session:
        async with session.get(url, headers=headers) as resp:
            resp.raise_for_status()
            data = await resp.json()
            return {"users": data.get("value", [])}
```

## Create New User

Provision a new Microsoft 365 user:

```python
from bifrost import workflow, integrations
import aiohttp

@workflow
async def create_user(email: str, display_name: str, password: str) -> dict:
    """Create new M365 user."""
    integration = await integrations.get("Microsoft")
    if not integration or not integration.oauth:
        raise ValueError("Microsoft Graph OAuth not configured")

    url = "https://graph.microsoft.com/v1.0/users"
    headers = {
        "Authorization": f"Bearer {integration.oauth.access_token}",
        "Content-Type": "application/json"
    }

    payload = {
        "accountEnabled": True,
        "displayName": display_name,
        "mailNickname": email.split("@")[0],
        "userPrincipalName": email,
        "passwordProfile": {
            "forceChangePasswordNextSignIn": True,
            "password": password
        }
    }

    async with aiohttp.ClientSession() as session:
        async with session.post(url, headers=headers, json=payload) as resp:
            if resp.status == 201:
                user = await resp.json()
                return {"success": True, "user_id": user["id"]}
            else:
                error = await resp.text()
                return {"success": False, "error": error}
```

## Update User Properties

Modify existing user attributes:

```python
@workflow
async def update_user(
    user_id: str,
    job_title: str | None = None,
    department: str | None = None
) -> dict:
    """Update user properties."""
    integration = await integrations.get("Microsoft")
    if not integration or not integration.oauth:
        raise ValueError("Microsoft Graph OAuth not configured")

    url = f"https://graph.microsoft.com/v1.0/users/{user_id}"
    headers = {
        "Authorization": f"Bearer {integration.oauth.access_token}",
        "Content-Type": "application/json"
    }

    # Build payload with only provided values
    payload = {}
    if job_title:
        payload["jobTitle"] = job_title
    if department:
        payload["department"] = department

    async with aiohttp.ClientSession() as session:
        async with session.patch(url, headers=headers, json=payload) as resp:
            if resp.status == 204:
                return {"success": True}
            else:
                return {"success": False, "error": await resp.text()}
```

## Add User to Group

Add users to security or Microsoft 365 groups:

```python
@workflow
async def add_to_group(user_id: str, group_id: str) -> dict:
    """Add user to group."""
    integration = await integrations.get("Microsoft")
    if not integration or not integration.oauth:
        raise ValueError("Microsoft Graph OAuth not configured")

    url = f"https://graph.microsoft.com/v1.0/groups/{group_id}/members/$ref"
    headers = {
        "Authorization": f"Bearer {integration.oauth.access_token}",
        "Content-Type": "application/json"
    }

    payload = {
        "@odata.id": f"https://graph.microsoft.com/v1.0/users/{user_id}"
    }

    async with aiohttp.ClientSession() as session:
        async with session.post(url, headers=headers, json=payload) as resp:
            if resp.status == 204:
                return {"success": True}
            else:
                return {"success": False, "error": await resp.text()}
```

## Assign License

Assign Microsoft 365 licenses to users:

```python
@workflow
async def assign_license(user_id: str, sku_id: str) -> dict:
    """Assign M365 license."""
    integration = await integrations.get("Microsoft")
    if not integration or not integration.oauth:
        raise ValueError("Microsoft Graph OAuth not configured")

    url = f"https://graph.microsoft.com/v1.0/users/{user_id}/assignLicense"
    headers = {
        "Authorization": f"Bearer {integration.oauth.access_token}",
        "Content-Type": "application/json"
    }

    payload = {
        "addLicenses": [{"skuId": sku_id}],
        "removeLicenses": []
    }

    async with aiohttp.ClientSession() as session:
        async with session.post(url, headers=headers, json=payload) as resp:
            if resp.status == 200:
                return {"success": True}
            else:
                return {"success": False, "error": await resp.text()}
```

## Handle Pagination

Get all results from large datasets:

```python
@workflow
async def get_all_users() -> dict:
    """Get all users with pagination."""
    integration = await integrations.get("Microsoft")
    if not integration or not integration.oauth:
        raise ValueError("Microsoft Graph OAuth not configured")

    headers = {"Authorization": f"Bearer {integration.oauth.access_token}"}

    all_users = []
    url = "https://graph.microsoft.com/v1.0/users?$top=100"

    async with aiohttp.ClientSession() as session:
        while url:
            async with session.get(url, headers=headers) as resp:
                resp.raise_for_status()
                data = await resp.json()
                all_users.extend(data.get("value", []))

                # Get next page URL
                url = data.get("@odata.nextLink")

    return {"users": all_users, "count": len(all_users)}
```

## Filter and Select

Use OData queries to get specific data:

  
```python
url = "https://graph.microsoft.com/v1.0/users?$filter=department eq 'Sales'"
```
  

{" "}

    ```python url =
    "https://graph.microsoft.com/v1.0/users?$select=displayName,mail,jobTitle"
    ```

  
```python
url = "https://graph.microsoft.com/v1.0/users?$filter=department eq 'Sales'&$select=displayName,mail&$top=50"
```
  

## Error Handling

Handle common Graph API errors:

```python
@workflow
async def safe_get_user(user_id: str) -> dict:
    """Get user with error handling."""
    integration = await integrations.get("Microsoft")
    if not integration or not integration.oauth:
        return {"success": False, "error": "OAuth not configured"}

    url = f"https://graph.microsoft.com/v1.0/users/{user_id}"
    headers = {"Authorization": f"Bearer {integration.oauth.access_token}"}

    async with aiohttp.ClientSession() as session:
        async with session.get(url, headers=headers) as resp:
            if resp.status == 200:
                user = await resp.json()
                return {"success": True, "user": user}
            elif resp.status == 404:
                return {"success": False, "error": "User not found"}
            elif resp.status == 403:
                return {"success": False, "error": "Insufficient permissions"}
            else:
                error = await resp.text()
                return {"success": False, "error": error}
```

## Common Scopes

| Operation               | Required Scope               |
| ----------------------- | ---------------------------- |
| Read users              | `User.Read.All`              |
| Create/update users     | `User.ReadWrite.All`         |
| Read groups             | `Group.Read.All`             |
| Manage group membership | `GroupMember.ReadWrite.All`  |
| Read licenses           | `Organization.Read.All`      |
| Assign licenses         | `Organization.ReadWrite.All` |

## Best Practices

1. **Always check integration**: Verify `integrations.get()` returns valid OAuth
2. **Use raise_for_status()**: Let HTTP errors bubble as exceptions
3. **Select only needed fields**: Use `$select` to reduce payload size
4. **Handle pagination**: Large result sets require paging
5. **Respect rate limits**: Graph API has throttling - implement retries if needed

## Next Steps

-   [OAuth Integration](/getting-started/integrations) - Set up Microsoft Graph OAuth
-   [Store API Keys Securely](/how-to-guides/integrations/secrets-management) - Manage credentials
-   [Custom APIs](/how-to-guides/integrations/custom-apis) - Integrate any REST API
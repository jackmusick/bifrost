name: bifrost-dev

# Development overrides for docker-compose.yml
#
# Usage:
#   docker compose -f docker-compose.yml -f docker-compose.dev.yml up
#
# This file adds development-specific configuration:
# - Hot reload with volume mounts for live code changes
# - Development-specific Dockerfiles (dependencies only)
# - Debug port for VS Code attachment
# - Management UI ports for RabbitMQ and MinIO
# - Development environment defaults

services:
  # PostgreSQL - development password default
  postgres:
    environment:
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-bifrost_dev}

  # RabbitMQ - development password + management UI port
  rabbitmq:
    environment:
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD:-bifrost_dev}
    ports:
      - "5672:5672"
      - "15672:15672"  # Management UI for debugging

  # MinIO - development password + console port
  minio:
    environment:
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-bifrost123}
    ports:
      - "9000:9000"
      - "9001:9001"  # Web Console for debugging

  # MinIO Init - development password default
  minio-init:
    environment:
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-bifrost123}

  # PgBouncer - development password default
  pgbouncer:
    environment:
      DB_PASSWORD: ${POSTGRES_PASSWORD:-bifrost_dev}

  # Init Container - development password defaults
  init:
    environment:
      BIFROST_ENVIRONMENT: development
      BIFROST_SECRET_KEY: ${BIFROST_SECRET_KEY:-dev-secret-key-change-in-production-must-be-32-chars}
      BIFROST_DATABASE_URL: postgresql+asyncpg://bifrost:${POSTGRES_PASSWORD:-bifrost_dev}@pgbouncer:5432/bifrost
      BIFROST_DATABASE_URL_SYNC: postgresql://bifrost:${POSTGRES_PASSWORD:-bifrost_dev}@pgbouncer:5432/bifrost
    volumes:
      - ./api/src:/app/src:ro
      - ./api/shared:/app/shared:ro
      - ./api/scripts:/app/scripts:ro
      - ./api/alembic:/app/alembic:ro
      - ./api/alembic.ini:/app/alembic.ini:ro

  # API with hot reload for development
  api:
    environment:
      BIFROST_ENVIRONMENT: development
      BIFROST_DEBUG: ${BIFROST_DEBUG:-true}
      BIFROST_SECRET_KEY: ${BIFROST_SECRET_KEY:-dev-secret-key-change-in-production-must-be-32-chars}
      BIFROST_DATABASE_URL: postgresql+asyncpg://bifrost:${POSTGRES_PASSWORD:-bifrost_dev}@pgbouncer:5432/bifrost
      BIFROST_DATABASE_URL_SYNC: postgresql://bifrost:${POSTGRES_PASSWORD:-bifrost_dev}@pgbouncer:5432/bifrost
      BIFROST_RABBITMQ_URL: amqp://bifrost:${RABBITMQ_PASSWORD:-bifrost_dev}@rabbitmq:5672/
      BIFROST_S3_SECRET_KEY: ${BIFROST_S3_SECRET_KEY:-${MINIO_ROOT_PASSWORD:-bifrost123}}
      # Debugging (optional - enables debugpy)
      ENABLE_DEBUG: ${ENABLE_DEBUG:-false}
    ports:
      - "5678:5678"  # debugpy port for VS Code attachment
    volumes:
      - ./api/src:/app/src:ro
      - ./api/shared:/app/shared:ro
      - ./api/bifrost:/app/bifrost:ro
      - ./api/platform:/app/platform:ro
      - ./api/alembic:/app/alembic:ro
      - ./api/alembic.ini:/app/alembic.ini:ro
    command: >
      sh -c "if [ \"$$ENABLE_DEBUG\" = \"true\" ]; then
               echo 'Starting with debugpy - waiting for VS Code to attach on port 5678...' &&
               python -m debugpy --listen 0.0.0.0:5678 --wait-for-client -m uvicorn src.main:app --host 0.0.0.0 --port 8000 --reload --reload-dir /app/src --reload-dir /app/shared;
             else
               uvicorn src.main:app --host 0.0.0.0 --port 8000 --reload --reload-dir /app/src --reload-dir /app/shared;
             fi"

  # Scheduler with hot reload for development
  scheduler:
    environment:
      BIFROST_ENVIRONMENT: development
      BIFROST_SECRET_KEY: ${BIFROST_SECRET_KEY:-dev-secret-key-change-in-production-must-be-32-chars}
      BIFROST_DATABASE_URL: postgresql+asyncpg://bifrost:${POSTGRES_PASSWORD:-bifrost_dev}@pgbouncer:5432/bifrost
      BIFROST_DATABASE_URL_SYNC: postgresql://bifrost:${POSTGRES_PASSWORD:-bifrost_dev}@pgbouncer:5432/bifrost
      BIFROST_RABBITMQ_URL: amqp://bifrost:${RABBITMQ_PASSWORD:-bifrost_dev}@rabbitmq:5672/
      BIFROST_S3_SECRET_KEY: ${BIFROST_S3_SECRET_KEY:-${MINIO_ROOT_PASSWORD:-bifrost123}}
    volumes:
      - ./api/src:/app/src:ro
      - ./api/shared:/app/shared:ro
      - ./api/bifrost:/app/bifrost:ro
      - ./api/platform:/app/platform:ro
    command: >
      watchmedo auto-restart --directory=/app/src --directory=/app/shared --pattern="*.py" --recursive -- python -m src.scheduler.main

  # Worker with hot reload for development
  worker:
    environment:
      BIFROST_ENVIRONMENT: development
      BIFROST_SECRET_KEY: ${BIFROST_SECRET_KEY:-dev-secret-key-change-in-production-must-be-32-chars}
      BIFROST_DATABASE_URL: postgresql+asyncpg://bifrost:${POSTGRES_PASSWORD:-bifrost_dev}@pgbouncer:5432/bifrost
      BIFROST_DATABASE_URL_SYNC: postgresql://bifrost:${POSTGRES_PASSWORD:-bifrost_dev}@pgbouncer:5432/bifrost
      BIFROST_RABBITMQ_URL: amqp://bifrost:${RABBITMQ_PASSWORD:-bifrost_dev}@rabbitmq:5672/
      BIFROST_S3_SECRET_KEY: ${BIFROST_S3_SECRET_KEY:-${MINIO_ROOT_PASSWORD:-bifrost123}}
    volumes:
      - ./api/src:/app/src:ro
      - ./api/shared:/app/shared:ro
      - ./api/bifrost:/app/bifrost:ro
      - ./api/platform:/app/platform:ro
    command: >
      watchmedo auto-restart --directory=/app/src --directory=/app/shared --pattern="*.py" --recursive -- python -m src.worker.main

  # Coding Agent with hot reload for development
  coding-agent:
    environment:
      BIFROST_ENVIRONMENT: development
      BIFROST_SECRET_KEY: ${BIFROST_SECRET_KEY:-dev-secret-key-change-in-production-must-be-32-chars}
      BIFROST_DATABASE_URL: postgresql+asyncpg://bifrost:${POSTGRES_PASSWORD:-bifrost_dev}@pgbouncer:5432/bifrost
      BIFROST_DATABASE_URL_SYNC: postgresql://bifrost:${POSTGRES_PASSWORD:-bifrost_dev}@pgbouncer:5432/bifrost
      BIFROST_RABBITMQ_URL: amqp://bifrost:${RABBITMQ_PASSWORD:-bifrost_dev}@rabbitmq:5672/
      BIFROST_S3_SECRET_KEY: ${BIFROST_S3_SECRET_KEY:-${MINIO_ROOT_PASSWORD:-bifrost123}}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}
    volumes:
      - ./api/src:/app/src:ro
      - ./api/shared:/app/shared:ro
      - ./api/bifrost:/app/bifrost:ro
      - ./api/platform:/app/platform:ro
    command: >
      watchmedo auto-restart --directory=/app/src --directory=/app/shared --pattern="*.py" --recursive -- python -m src.coding_agent.main

  # Client with hot reload for development
  client:
    build:
      context: ./client
      dockerfile: Dockerfile.dev
      target: "" # Clear the production target from base compose file
    volumes:
      - ./client/src:/app/src
      - ./client/public:/app/public
      - ./client/index.html:/app/index.html
      - ./client/vite.config.ts:/app/vite.config.ts
      - ./client/tsconfig.json:/app/tsconfig.json
      - ./client/tsconfig.app.json:/app/tsconfig.app.json
      - ./client/tsconfig.node.json:/app/tsconfig.node.json
      - ./client/tailwind.config.ts:/app/tailwind.config.ts
      - ./client/postcss.config.js:/app/postcss.config.js

# Test Fixes - January 10, 2026

## Completed: Test Skip Cleanup

Reviewed all 89 skipped tests and removed 56 unnecessary skips that were masking real issues.

### Changes Made

#### Phase 1: Websocket Import Checks (35 tests)
**Files:** `test_websocket.py`, `test_coding_mode.py`

Removed redundant `ImportError` try/except blocks. The `websockets` library is in `requirements.txt`, so if the import fails, the environment is broken - tests should fail, not skip.

Also removed generic exception handlers that were hiding real failures:
```python
# REMOVED - hides real failures
except Exception as e:
    pytest.skip(f"WebSocket connection failed: {e}")
```

#### Phase 2: Workflow Fixture Checks (16 tests)
**File:** `test_executions.py`

Removed defensive workflow ID checks. The fixtures already assert workflow discovery works:
```python
# REMOVED - redundant, fixture already asserts this
if not sync_workflow["id"]:
    pytest.skip("Sync workflow not discovered")
```

#### Phase 3: Temp Directory Skips (5 tests)
**File:** `test_cli.py`

Converted "skip on 500" to proper assertions. A 500 error is a server bug, not a skip condition:
```python
# BEFORE
if response.status_code == 500:
    pytest.skip("Temp directory not available")

# AFTER
assert response.status_code == 204, f"Write failed: {response.text}"
```

#### Phase 4: Event Delivery Timeout (1 test)
**File:** `test_events.py`

Increased timeout from 5s to 15s and converted skip to assertion:
```python
# BEFORE
if result is None:
    pytest.skip("No deliveries created within timeout")

# AFTER
assert result is not None, "No deliveries created within timeout - event delivery may be broken"
```

#### Phase 5: Concurrent Execution Skip (1 test)
**File:** `test_executions.py`

Removed CI-only skip for `test_concurrent_executions_not_blocking`. The test uses database timestamps (not wall-clock) specifically to avoid timing issues. If it fails in CI, that indicates a real concurrency problem.

### Additional Fixes

- Fixed type errors in websocket tests (`close_code` â†’ `code` for websockets 13+)
- Converted implicit fixture dependencies to `@pytest.mark.usefixtures`
- Removed unused imports (`os`, `pytest` where no longer needed)
- Fixed f-strings without placeholders

### Verification

All 105 modified tests pass:
```
./test.sh tests/e2e/api/test_websocket.py tests/e2e/api/test_coding_mode.py \
  tests/e2e/api/test_executions.py tests/e2e/api/test_cli.py tests/e2e/api/test_events.py
# Result: 105 passed, 4 warnings
```

---

## Outstanding Issues (Pre-existing)

The full test suite revealed pre-existing failures unrelated to our changes:

### 1. Virtual Import Tests - 13 Failures

**File:** `tests/unit/services/test_virtual_import.py`

Tests reference functions/attributes that don't exist in the implementation:
- `get_module_index_sync` - function doesn't exist
- `VirtualModuleFinder._module_index` - attribute doesn't exist

**Root Cause:** Implementation was refactored but tests weren't updated.

**TODO:**
- [ ] Review `src/services/execution/virtual_import.py` implementation
- [ ] Update tests to match current API, or restore missing functionality

### 2. GitHub Tests - 9 Errors

**File:** `tests/e2e/api/test_github.py`

Tests fail with `BadCredentialsException` because `GITHUB_TEST_PAT` is invalid/expired.

**Root Cause:** The `github_test_config` fixture in `tests/e2e/fixtures/github_setup.py` validates the token but doesn't properly skip when validation fails - it raises an error instead.

**TODO:**
- [ ] Fix `github_test_config` fixture to skip gracefully on invalid credentials
- [ ] Ensure all GitHub tests properly depend on the fixture
- [ ] Update CI to either provide valid token or expect these tests to skip

---

## Legitimate Skips (Correct Behavior)

These skips should remain:

| Location | Test/Fixture | Reason |
|----------|-------------|--------|
| `test_llm_config.py` | 6 tests | Requires `ANTHROPIC_API_TEST_KEY`, `OPENAPI_API_TEST_KEY` |
| `llm_setup.py` | 2 fixtures | Same API key requirements |
| `github_setup.py` | 4 fixtures | Requires `GITHUB_TEST_PAT` |
| `knowledge_setup.py` | 1 fixture | Requires `EMBEDDINGS_API_TEST_KEY` |
| `test_github.py` | `test_create_repository` | Creates real GitHub repos - manual only |
| `test_sdk_credentials.py` | 2 tests | Unix permissions not applicable on Windows |

---

## Files Modified

```
api/tests/e2e/api/test_websocket.py
api/tests/e2e/api/test_coding_mode.py
api/tests/e2e/api/test_executions.py
api/tests/e2e/api/test_cli.py
api/tests/e2e/api/test_events.py
```
